---
/**
 * EssayCard Component - V2 Design
 *
 * Premium essay preview card with:
 * - Large title with hover effects
 * - Category badge with color coding
 * - Critical flag indicator
 * - Related findings links
 * - Reading time estimate
 * - Glassmorphism styling
 */

import Badge from '@components/common/Badge.astro';

interface Props {
  essay: {
    id: string;
    title: string;
    subtitle?: string;
    date: string;
    version?: string;
    category: string;
    status?: string;
    keyFindings?: string[];
    summary: string;
    keyArguments?: string[];
    critical?: boolean;
  };
  featured?: boolean;
}

const { essay, featured = false } = Astro.props;

const base = import.meta.env.BASE_URL;
const getHref = (path: string) => path === '/' ? (base || '/') : `${base}${path}`;

// Category styling
type BadgeVariant = 'vindication' | 'breach' | 'discrepancy' | 'causation' | 'quantum' | 'procedural' | 'strategic' | 'witness' | 'fabrication' | 'default';

const categoryStyles: Record<string, {
  variant: BadgeVariant;
  bg: string;
  border: string;
  icon: string;
  iconColor: string;
}> = {
  'BREACH': {
    variant: 'breach',
    bg: 'bg-gradient-to-br from-red-500/5 via-navy-800/50 to-navy-800/50',
    border: 'border-red-500/30 hover:border-red-500/50',
    icon: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z',
    iconColor: 'text-red-400'
  },
  'CAUSATION': {
    variant: 'causation',
    bg: 'bg-gradient-to-br from-purple-500/5 via-navy-800/50 to-navy-800/50',
    border: 'border-purple-500/30 hover:border-purple-500/50',
    icon: 'M13 10V3L4 14h7v7l9-11h-7z',
    iconColor: 'text-purple-400'
  },
  'VINDICATION': {
    variant: 'vindication',
    bg: 'bg-gradient-to-br from-green-500/5 via-navy-800/50 to-navy-800/50',
    border: 'border-green-500/30 hover:border-green-500/50',
    icon: 'M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z',
    iconColor: 'text-green-400'
  },
  'PROCEDURAL': {
    variant: 'procedural',
    bg: 'bg-gradient-to-br from-cyan-500/5 via-navy-800/50 to-navy-800/50',
    border: 'border-cyan-500/30 hover:border-cyan-500/50',
    icon: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2',
    iconColor: 'text-cyan-400'
  }
};

const style = categoryStyles[essay.category] || {
  variant: 'default' as BadgeVariant,
  bg: 'bg-navy-800/50',
  border: 'border-navy-700/50 hover:border-navy-600/50',
  icon: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
  iconColor: 'text-navy-400'
};

// Estimate reading time based on summary + arguments
const wordCount = (essay.summary?.split(' ').length || 0) +
  (essay.keyArguments?.join(' ').split(' ').length || 0);
const readingTime = Math.max(5, Math.ceil(wordCount / 200) + 3); // Assume full essay is ~5x longer
---

<article
  class="essay-card group relative"
  data-essay-id={essay.id}
  data-category={essay.category}
>
  <div class:list={[
    'relative overflow-hidden rounded-2xl border backdrop-blur-xl transition-all duration-300',
    'hover:shadow-xl hover:shadow-navy-900/50',
    style.bg,
    style.border,
    featured ? 'p-8' : 'p-6'
  ]}>
    <!-- Critical Badge -->
    {essay.critical && (
      <div class="absolute top-4 right-4 z-10">
        <div class="flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-gold-500/20 text-gold-400 text-xs font-semibold border border-gold-500/30">
          <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
          </svg>
          CRITICAL
        </div>
      </div>
    )}

    <!-- Category Icon -->
    <div class:list={[
      'w-12 h-12 rounded-xl flex items-center justify-center mb-4',
      `bg-${style.iconColor.replace('text-', '')}/10`
    ]}>
      <svg class:list={['w-6 h-6', style.iconColor]} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={style.icon} />
      </svg>
    </div>

    <!-- Header -->
    <div class="flex items-start justify-between gap-4 mb-4">
      <Badge variant={style.variant}>{essay.category}</Badge>
      <div class="flex items-center gap-3 text-xs text-navy-500">
        <span class="flex items-center gap-1">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          {readingTime} min read
        </span>
        <span>{essay.date}</span>
      </div>
    </div>

    <!-- Title -->
    <h3 class:list={[
      'font-display font-bold text-white mb-2 group-hover:text-gold-400 transition-colors leading-tight',
      featured ? 'text-2xl' : 'text-xl'
    ]}>
      {essay.title}
    </h3>

    <!-- Subtitle -->
    {essay.subtitle && (
      <p class:list={[
        'text-navy-400 mb-4 leading-relaxed',
        featured ? 'text-base' : 'text-sm'
      ]}>
        {essay.subtitle}
      </p>
    )}

    <!-- Summary -->
    <p class="text-sm text-navy-300 mb-6 leading-relaxed line-clamp-3">
      {essay.summary}
    </p>

    <!-- Key Arguments Preview (featured only) -->
    {featured && essay.keyArguments && essay.keyArguments.length > 0 && (
      <div class="mb-6 p-4 bg-navy-900/50 rounded-xl border border-navy-700/30">
        <h4 class="text-xs font-semibold text-navy-500 uppercase tracking-wider mb-3">Key Arguments</h4>
        <ul class="space-y-2">
          {essay.keyArguments.slice(0, 3).map((arg) => (
            <li class="flex items-start gap-2 text-sm text-navy-300">
              <svg class:list={['w-4 h-4 mt-0.5 flex-shrink-0', style.iconColor]} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
              <span class="line-clamp-1">{arg}</span>
            </li>
          ))}
          {essay.keyArguments.length > 3 && (
            <li class="text-xs text-navy-500 pl-6">+{essay.keyArguments.length - 3} more arguments</li>
          )}
        </ul>
      </div>
    )}

    <!-- Related Findings -->
    {essay.keyFindings && essay.keyFindings.length > 0 && (
      <div class="flex items-center gap-2 flex-wrap">
        <span class="text-xs text-navy-500">Related:</span>
        {essay.keyFindings.slice(0, featured ? 6 : 4).map((findingId) => (
          <a
            href={getHref(`/findings/${findingId.toLowerCase()}`)}
            class="text-xs font-mono px-2 py-0.5 rounded bg-navy-700/50 text-gold-500 hover:bg-navy-600/50 hover:text-gold-400 transition-colors"
          >
            {findingId}
          </a>
        ))}
        {essay.keyFindings.length > (featured ? 6 : 4) && (
          <span class="text-xs text-navy-500">+{essay.keyFindings.length - (featured ? 6 : 4)}</span>
        )}
      </div>
    )}

    <!-- Version Badge -->
    {essay.version && (
      <div class="absolute bottom-4 right-4">
        <span class="text-xs text-navy-600 font-mono">v{essay.version}</span>
      </div>
    )}

    <!-- Hover Arrow -->
    <div class="absolute bottom-6 right-6 opacity-0 group-hover:opacity-100 transition-opacity">
      <svg class="w-5 h-5 text-gold-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
      </svg>
    </div>
  </div>
</article>

<style>
  .essay-card {
    opacity: 0;
    animation: card-appear 0.5s ease-out forwards;
  }

  @keyframes card-appear {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
