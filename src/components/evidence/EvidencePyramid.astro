---
/**
 * EvidencePyramid Component - V2 Design
 *
 * Interactive 3D-style pyramid visualization showing evidence hierarchy.
 * Features:
 * - Stacked tier blocks with perspective
 * - Hover expansion with details
 * - Color coding by reliability
 * - Animated reveal on scroll
 */

interface EvidenceTier {
  tier: number;
  name: string;
  description: string;
  reliability: string;
  color: string;
  count: number | string;
  examples?: string[];
}

interface Props {
  tiers: EvidenceTier[];
  compact?: boolean;
}

const { tiers, compact = false } = Astro.props;

// Color mapping
const tierColors: Record<string, {
  bg: string;
  border: string;
  glow: string;
  text: string;
  badge: string;
}> = {
  gold: {
    bg: 'bg-gradient-to-br from-gold-500/20 via-gold-500/10 to-amber-600/20',
    border: 'border-gold-500/40',
    glow: 'shadow-gold-500/20',
    text: 'text-gold-400',
    badge: 'bg-gold-500/20 text-gold-400 border-gold-500/30'
  },
  vindication: {
    bg: 'bg-gradient-to-br from-green-500/15 via-green-500/5 to-emerald-600/15',
    border: 'border-green-500/30',
    glow: 'shadow-green-500/15',
    text: 'text-green-400',
    badge: 'bg-green-500/20 text-green-400 border-green-500/30'
  },
  causation: {
    bg: 'bg-gradient-to-br from-purple-500/15 via-purple-500/5 to-violet-600/15',
    border: 'border-purple-500/30',
    glow: 'shadow-purple-500/15',
    text: 'text-purple-400',
    badge: 'bg-purple-500/20 text-purple-400 border-purple-500/30'
  },
  breach: {
    bg: 'bg-gradient-to-br from-red-500/15 via-red-500/5 to-rose-600/15',
    border: 'border-red-500/30',
    glow: 'shadow-red-500/15',
    text: 'text-red-400',
    badge: 'bg-red-500/20 text-red-400 border-red-500/30'
  },
  default: {
    bg: 'bg-gradient-to-br from-navy-700/50 via-navy-700/30 to-navy-800/50',
    border: 'border-navy-600/40',
    glow: 'shadow-navy-500/10',
    text: 'text-navy-300',
    badge: 'bg-navy-700/50 text-navy-300 border-navy-600/30'
  }
};

const getTierStyle = (color: string) => tierColors[color] || tierColors.default;
---

<div class="evidence-pyramid relative py-8" data-compact={compact}>
  <!-- 3D Perspective Container -->
  <div class="pyramid-container relative max-w-4xl mx-auto" style="perspective: 1200px;">
    <!-- Vertical Guide Lines -->
    <div class="absolute inset-0 pointer-events-none">
      <div class="absolute left-1/2 top-0 bottom-0 w-px bg-gradient-to-b from-gold-500/30 via-navy-600/20 to-red-500/30 transform -translate-x-1/2"></div>
    </div>

    <!-- Pyramid Tiers -->
    <div class="relative space-y-2">
      {tiers.map((tier, index) => {
        const style = getTierStyle(tier.color);
        // Width increases as we go down (inverse pyramid - top is smallest)
        const widthPercent = 35 + (index * 9.5);
        // Subtle 3D offset
        const offset = index * 2;

        return (
          <div
            class="pyramid-tier group relative mx-auto cursor-pointer"
            style={`width: ${widthPercent}%; animation-delay: ${index * 100}ms;`}
            data-tier={tier.tier}
          >
            <!-- 3D Shadow Layer -->
            <div
              class="absolute inset-0 rounded-xl bg-black/20 blur-md transform translate-y-1 translate-x-1"
              style={`transform: translateY(${4 + offset}px) translateX(${2}px);`}
            ></div>

            <!-- Main Tier Block -->
            <div class:list={[
              'relative rounded-xl border backdrop-blur-xl transition-all duration-300',
              'group-hover:scale-[1.02] group-hover:z-10 group-hover:shadow-2xl',
              style.bg,
              style.border,
              `shadow-lg ${style.glow}`,
              compact ? 'p-3' : 'p-4 sm:p-5'
            ]}>
              <!-- Tier Content -->
              <div class="flex items-center justify-between gap-4">
                <!-- Left: Tier Number + Name -->
                <div class="flex items-center gap-3 sm:gap-4">
                  <!-- Tier Number Badge -->
                  <div class:list={[
                    'flex-shrink-0 rounded-lg flex items-center justify-center font-display font-bold border',
                    style.badge,
                    compact ? 'w-10 h-10 text-lg' : 'w-12 h-12 sm:w-14 sm:h-14 text-xl sm:text-2xl'
                  ]}>
                    {tier.tier}
                  </div>

                  <div class="min-w-0">
                    <h3 class:list={[
                      'font-display font-semibold text-white truncate',
                      compact ? 'text-sm' : 'text-sm sm:text-base'
                    ]}>
                      {tier.name}
                    </h3>
                    <p class:list={[
                      'text-navy-400 hidden sm:block truncate',
                      compact ? 'text-xs' : 'text-xs sm:text-sm'
                    ]}>
                      {tier.reliability}
                    </p>
                  </div>
                </div>

                <!-- Right: Count Badge -->
                <div class:list={[
                  'flex-shrink-0 px-3 py-1.5 rounded-lg font-mono font-semibold border',
                  style.badge,
                  compact ? 'text-xs' : 'text-sm'
                ]}>
                  {tier.count}
                </div>
              </div>

              <!-- Expanded Details (shown on hover) -->
              {!compact && (
                <div class="tier-details mt-0 max-h-0 overflow-hidden transition-all duration-300 group-hover:mt-4 group-hover:max-h-40">
                  <p class="text-sm text-navy-400 mb-3">{tier.description}</p>
                  {tier.examples && tier.examples.length > 0 && (
                    <div class="flex flex-wrap gap-2">
                      {tier.examples.slice(0, 3).map((example) => (
                        <span class="text-xs px-2 py-1 rounded bg-navy-900/50 text-navy-300 border border-navy-700/50">
                          {example.length > 35 ? example.substring(0, 32) + '...' : example}
                        </span>
                      ))}
                      {tier.examples.length > 3 && (
                        <span class="text-xs px-2 py-1 rounded bg-navy-900/50 text-navy-500">
                          +{tier.examples.length - 3} more
                        </span>
                      )}
                    </div>
                  )}
                </div>
              )}
            </div>

            <!-- Connecting Line to Next Tier -->
            {index < tiers.length - 1 && (
              <div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 z-0">
                <div class="w-px h-4 bg-gradient-to-b from-navy-600/50 to-transparent"></div>
              </div>
            )}
          </div>
        );
      })}
    </div>

    <!-- Apex Label -->
    <div class="absolute -top-8 left-1/2 transform -translate-x-1/2 text-center">
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-gold-500/10 border border-gold-500/20">
        <svg class="w-4 h-4 text-gold-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
        </svg>
        <span class="text-xs font-medium text-gold-400">Highest Reliability</span>
      </div>
    </div>

    <!-- Base Label -->
    <div class="text-center mt-6">
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-red-500/10 border border-red-500/20">
        <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <span class="text-xs font-medium text-red-400">Requires Verification</span>
      </div>
    </div>
  </div>
</div>

<style>
  .pyramid-tier {
    opacity: 0;
    animation: tier-appear 0.5s ease-out forwards;
  }

  @keyframes tier-appear {
    from {
      opacity: 0;
      transform: translateY(-20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  /* Hover state for expanded details */
  .tier-details {
    opacity: 0;
    transition: opacity 0.3s ease, max-height 0.3s ease, margin-top 0.3s ease;
  }

  .pyramid-tier:hover .tier-details {
    opacity: 1;
  }

  /* 3D hover effect */
  .pyramid-tier:hover {
    transform: translateY(-2px);
  }
</style>

<script>
  // Intersection Observer for scroll-triggered animation
  document.addEventListener('DOMContentLoaded', () => {
    const pyramid = document.querySelector('.evidence-pyramid');
    const tiers = document.querySelectorAll('.pyramid-tier');

    if (pyramid && tiers.length > 0) {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              tiers.forEach((tier, index) => {
                (tier as HTMLElement).style.animationPlayState = 'running';
              });
            }
          });
        },
        { threshold: 0.2 }
      );

      observer.observe(pyramid);

      // Initially pause animations
      tiers.forEach((tier) => {
        (tier as HTMLElement).style.animationPlayState = 'paused';
      });
    }
  });
</script>
