---
/**
 * FindingCard Component - V2 Design
 *
 * Evidence folder-styled card for displaying forensic findings.
 * Features physical evidence folder tab, glassmorphism styling,
 * and hover reveals for related information.
 */

import Badge from '@components/common/Badge.astro';
import GlassCard from '@components/ui/GlassCard.astro';

interface Props {
  finding: {
    id: string;
    title: string;
    category: string;
    summary: string;
    evidenceStatus: string;
    legalSignificance?: string;
    date?: string;
    critical?: boolean;
    relatedFindings?: string[];
    relatedActors?: string[];
    source?: string;
  };
  expanded?: boolean;
  showRelated?: boolean;
}

const { finding, expanded = false, showRelated = true } = Astro.props;

const base = import.meta.env.BASE_URL;
const getHref = (path: string) => path === '/' ? (base || '/') : `${base}${path}`;

// Badge variant type
type BadgeVariant = 'vindication' | 'breach' | 'discrepancy' | 'causation' | 'quantum' | 'procedural' | 'strategic' | 'witness' | 'fabrication' | 'default';

// Category to variant mapping
const categoryMap: Record<string, BadgeVariant> = {
  'VINDICATION': 'vindication',
  'BREACH': 'breach',
  'DISCREPANCY': 'discrepancy',
  'CAUSATION': 'causation',
  'QUANTUM': 'quantum',
  'PROCEDURAL': 'procedural',
  'STRATEGIC': 'strategic',
  'WITNESS': 'witness',
  'FABRICATION': 'fabrication',
  'NEUROLOGICAL': 'causation',
  'MEDICATION': 'breach',
  'FND/SOMATOFORM': 'breach'
};

const variant: BadgeVariant = categoryMap[finding.category] || 'default';

// Status styling
const statusStyles: Record<string, { bg: string; text: string; icon: string }> = {
  'VERIFIED': {
    bg: 'bg-green-500/20',
    text: 'text-green-400',
    icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'
  },
  'SUPPORTED': {
    bg: 'bg-blue-500/20',
    text: 'text-blue-400',
    icon: 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'
  },
  'UNVERIFIED': {
    bg: 'bg-yellow-500/20',
    text: 'text-yellow-400',
    icon: 'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'
  },
  'DISPUTED': {
    bg: 'bg-orange-500/20',
    text: 'text-orange-400',
    icon: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z'
  },
  'CONTRADICTED': {
    bg: 'bg-red-500/20',
    text: 'text-red-400',
    icon: 'M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z'
  }
};

const status = finding.evidenceStatus?.toUpperCase() || 'UNVERIFIED';
const statusStyle = statusStyles[status] || statusStyles['UNVERIFIED'];

// Tab color based on category
const tabColors: Record<string, string> = {
  'vindication': 'bg-green-500',
  'breach': 'bg-red-500',
  'discrepancy': 'bg-amber-500',
  'causation': 'bg-purple-500',
  'fabrication': 'bg-red-600',
  'witness': 'bg-blue-500',
  'quantum': 'bg-cyan-500',
  'procedural': 'bg-slate-500',
  'strategic': 'bg-indigo-500',
  'default': 'bg-navy-500'
};

const tabColor = tabColors[variant] || tabColors['default'];
---

<article
  class="finding-card group relative"
  data-finding-id={finding.id}
  data-category={finding.category}
  transition:name={`finding-${finding.id}`}
>
  <!-- Evidence Folder Tab -->
  <div class="absolute -top-3 left-6 z-10">
    <div class:list={[
      'px-3 py-1 rounded-t-lg text-xs font-mono font-bold tracking-wider',
      'shadow-lg transform group-hover:-translate-y-0.5 transition-transform duration-300',
      tabColor,
      finding.critical ? 'ring-2 ring-gold-500 ring-offset-2 ring-offset-navy-900' : ''
    ]}>
      {finding.id}
      {finding.critical && (
        <span class="ml-1 text-gold-300">â˜…</span>
      )}
    </div>
  </div>

  <!-- Main Card Body -->
  <div class="bg-navy-800/50 backdrop-blur-xl border border-navy-700/50 rounded-2xl rounded-tl-none pt-6 pb-5 px-6 transition-all duration-300 group-hover:bg-navy-800/70 group-hover:border-navy-600/60 group-hover:shadow-xl">
    <!-- Header Row -->
    <div class="flex items-start justify-between mb-4">
      <div class="flex items-center gap-3 flex-wrap">
        <Badge variant={variant}>{finding.category}</Badge>
        {finding.date && (
          <span class="text-xs text-navy-500 font-mono">{finding.date}</span>
        )}
      </div>

      <!-- Evidence Status Badge -->
      <div class:list={[
        'flex items-center gap-1.5 px-2 py-1 rounded-full text-xs font-medium',
        statusStyle.bg,
        statusStyle.text
      ]}>
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={statusStyle.icon} />
        </svg>
        {status}
      </div>
    </div>

    <!-- Title -->
    <h3 class="text-lg font-display font-semibold text-white mb-3 group-hover:text-gold-400 transition-colors leading-snug">
      {finding.title}
    </h3>

    <!-- Summary -->
    <p class="text-sm text-navy-300 leading-relaxed line-clamp-3 mb-4">
      {finding.summary || 'No summary available'}
    </p>

    <!-- Legal Significance (expanded only) -->
    {expanded && finding.legalSignificance && (
      <div class="mb-4 p-3 bg-navy-900/50 rounded-lg border-l-2 border-gold-500/50">
        <h4 class="text-xs font-semibold text-gold-500 uppercase tracking-wider mb-2 flex items-center gap-2">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
          </svg>
          Legal Significance
        </h4>
        <p class="text-sm text-navy-300 leading-relaxed">{finding.legalSignificance}</p>
      </div>
    )}

    <!-- Related Findings (hover reveal) -->
    {showRelated && finding.relatedFindings && finding.relatedFindings.length > 0 && (
      <div class="related-findings overflow-hidden max-h-0 opacity-0 group-hover:max-h-24 group-hover:opacity-100 transition-all duration-500 ease-out">
        <div class="flex items-center gap-2 flex-wrap pt-3 border-t border-navy-700/50">
          <span class="text-xs text-navy-500">Related:</span>
          {finding.relatedFindings.slice(0, 4).map((refId) => (
            <a
              href={getHref(`/findings/${refId.toLowerCase()}`)}
              class="text-xs font-mono px-2 py-0.5 rounded bg-navy-700/50 text-navy-300 hover:bg-navy-600/50 hover:text-white transition-colors"
            >
              {refId}
            </a>
          ))}
          {finding.relatedFindings.length > 4 && (
            <span class="text-xs text-navy-500">+{finding.relatedFindings.length - 4} more</span>
          )}
        </div>
      </div>
    )}

    <!-- Footer Actions -->
    <div class="flex items-center justify-between pt-4 border-t border-navy-700/30">
      {finding.source && (
        <span class="text-xs text-navy-500 truncate max-w-[200px]" title={finding.source}>
          {finding.source}
        </span>
      )}
      <a
        href={getHref(`/findings/${finding.id.toLowerCase()}`)}
        class="text-sm text-gold-500 hover:text-gold-400 transition-colors inline-flex items-center gap-2 ml-auto group/link"
      >
        View Details
        <svg class="w-4 h-4 transform group-hover/link:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </a>
    </div>
  </div>
</article>

<style>
  .finding-card {
    /* Ensure smooth transitions */
    transform: translateZ(0);
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Stagger animation for grid appearance */
  @keyframes card-appear {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .finding-card {
    animation: card-appear 0.5s ease-out forwards;
  }

  /* Critical finding glow effect */
  .finding-card[data-critical="true"]:hover {
    box-shadow: 0 0 30px rgba(212, 175, 55, 0.2);
  }
</style>
