---
import BaseLayout from '@layouts/BaseLayout.astro';
import PhaseCard from '@components/timeline/PhaseCard.astro';
import Badge from '@components/common/Badge.astro';

// Timeline phases data
const phases = [
  {
    number: 1,
    title: 'Pre-Existing Conditions & Early Dismissal Pattern',
    dateRange: 'Pre-2020 to October 2020',
    events: [
      {
        date: '13 Jun 2019',
        title: 'Duplex Ultrasound Shows TOS-Positive Result',
        description: 'Complete flow cessation in distal subclavian artery during provocative manoeuvres. "Positive result" documented.',
        status: 'verified',
        findingRef: 'F032'
      },
      {
        date: 'Pre-2020',
        title: 'Ehlers-Danlos Syndrome Diagnosed',
        description: 'Chronic pain documented across multiple specialist letters. DEXA scan shows T/Z scores in osteopenic range.',
        status: 'verified'
      }
    ]
  },
  {
    number: 2,
    title: 'Psychiatric Framing Begins',
    dateRange: 'October 2020 - December 2021',
    events: [
      {
        date: '28 Sep 2020',
        title: 'MH1 Referral: Somatisation Framing',
        description: 'GP referral explicitly links "somatisation" to brother\'s death. No psychiatric assessment conducted.',
        status: 'contradicted',
        findingRef: 'F002'
      },
      {
        date: '23 Oct 2020',
        title: 'GP Documents "Same Path as Brother"',
        description: 'Dr Gupta records patient is "on same path as his brother who committed suicide after chronic pain."',
        status: 'contradicted'
      },
      {
        date: '04 Aug 2021',
        title: 'MSK Physio Documents GP Dismissal',
        description: '"issues with GP, as they did not believe his pain and accused him for attention seeking"',
        status: 'verified',
        findingRef: 'F022'
      },
      {
        date: 'Sep 2021',
        title: '"Sleeping Pain-Free" Entry',
        description: 'Dr Bulale records patient "sleeping pain-free" - contradicted by MSK physio documenting inability to sleep.',
        status: 'contradicted',
        findingRef: 'F001'
      },
      {
        date: 'Oct 2021',
        title: 'Pregabalin Drastically Reduced',
        description: '600mg to 100mg (83% reduction) against BNF guidance for gradual taper. Seizure risk factor.',
        status: 'contradicted',
        findingRef: 'F042'
      },
      {
        date: '23 Nov 2021',
        title: 'Pain Clinic Rejects Referral',
        description: 'Patient rejected without being consulted. Discharged because mother mentioned low mood/suicidal concerns.',
        status: 'verified',
        findingRef: 'F027'
      }
    ]
  },
  {
    number: 3,
    title: 'The Index Event - First Seizure',
    dateRange: '23-24 December 2021',
    events: [
      {
        date: '23 Dec 2021',
        title: 'Witnessed Tonic-Clonic Seizure',
        description: '5-minute ambulance response (Category 1/2), HR 133 bpm tachycardia, Entonox administered for back pain. "Extremely combative and confused post seizure, held to ground by father."',
        status: 'verified',
        findingRef: 'F023'
      },
      {
        date: '24 Dec 2021',
        title: 'A&E Attendance - Back Pain Dismissed',
        description: 'Labelled "soft tissue injury" - no spinal imaging ordered despite EDS and violent seizure mechanism.',
        status: 'contradicted',
        findingRef: 'F047'
      }
    ]
  },
  {
    number: 4,
    title: 'Diagnostic Delay & Dismissal Pattern',
    dateRange: 'January 2022 - November 2022',
    events: [
      {
        date: '18 Feb 2022',
        title: 'ED Diagnoses Tonic-Clonic Epilepsy',
        description: 'Imperial ED explicitly confirms "first seizure on 23/12" and diagnoses epilepsy.',
        status: 'verified',
        findingRef: 'F024'
      },
      {
        date: '26 Feb 2022',
        title: 'Second Witnessed Seizure',
        description: 'Another witnessed tonic-clonic seizure event.',
        status: 'verified'
      },
      {
        date: '22 Mar 2022',
        title: 'Neurology Letter - History Divergence',
        description: 'Dr Karunaratne documents seizure history but does not clearly anchor first seizure to 23 Dec 2021.',
        status: 'verified',
        findingRef: 'F003'
      }
    ]
  },
  {
    number: 5,
    title: 'Fracture Discovery - 11 Month Delay',
    dateRange: 'November 2022',
    events: [
      {
        date: 'Nov 2022',
        title: 'MRI Reveals T5-T8 Vertebral Fractures',
        description: '11 months after the seizure, imaging finally shows multiple thoracic fractures that explain ongoing pain.',
        status: 'verified',
        findingRef: 'F050'
      }
    ]
  },
  {
    number: 6,
    title: 'Covert Psychiatric Diagnosis Applied',
    dateRange: 'January 2023',
    events: [
      {
        date: '05 Jan 2023',
        title: 'Somatoform Pain Disorder F45.4 Applied',
        description: 'Psychiatric diagnosis coded WITHOUT psychiatric assessment, WITHOUT patient knowledge, and without clinical justification.',
        status: 'contradicted',
        findingRef: 'F040'
      }
    ]
  },
  {
    number: 7,
    title: 'Vindication Phase',
    dateRange: '2023 - 2025',
    events: [
      {
        date: '2023',
        title: 'Pain Clinic Refutes Somatoform Diagnosis',
        description: 'Chelsea & Westminster Pain Clinic: "GP prev told somatic, pain clinic at C&W; felt not somatic."',
        status: 'verified',
        findingRef: 'F031'
      },
      {
        date: '2023',
        title: 'Psychiatric Assessment Clearance',
        description: 'Dr Gupta (psychiatrist) finds NO: PTSD, depression, psychosis, personality disorder, OR somatisation disorder.',
        status: 'verified',
        findingRef: 'F038'
      },
      {
        date: '17 Oct 2023',
        title: 'Dr Gorrie Recognises Seizure/Fractures',
        description: 'New GP properly recognises 2021 seizure/fracture pattern and refers to orthopaedics.',
        status: 'verified',
        findingRef: 'F034'
      },
      {
        date: '10 Jan 2024',
        title: 'UCLH MR Confirms TOS',
        description: 'Dynamic MR shows compression of subclavian artery and vein with arms abducted.',
        status: 'verified',
        findingRef: 'F033'
      },
      {
        date: '09 Jun 2025',
        title: 'Doppler Shows Bilateral Subclavian Occlusion',
        description: 'Royal Free ultrasound confirms dynamic vascular compression. At 90Â° abduction: "compressed with no flow."',
        status: 'verified',
        findingRef: 'F036'
      },
      {
        date: '22 Jul 2025',
        title: 'Dr Gorrie Removes Somatoform Diagnosis',
        description: 'Marked as INACTIVE: "there were clear causes for his pain." Unusual without psychiatric reassessment.',
        status: 'verified',
        findingRef: 'F030'
      },
      {
        date: 'Dec 2024',
        title: 'Formal Epilepsy Diagnosis Confirmed',
        description: 'Epilepsy formally diagnosed, validating all prior seizure events.',
        status: 'verified',
        findingRef: 'F354'
      }
    ]
  },
  {
    number: 8,
    title: 'Current Status',
    dateRange: '2026',
    events: [
      {
        date: 'Jan 2026',
        title: 'Evidence Repository Compiled',
        description: '200+ findings documented. Case ready for legal review with comprehensive evidence chain.',
        status: 'verified'
      }
    ]
  }
];

const keyDates = [
  { date: 'Dec 2021', label: 'First Seizure', color: 'bg-breach-500' },
  { date: 'Nov 2022', label: 'Fractures Found', color: 'bg-gold-500' },
  { date: 'Jan 2023', label: 'Covert Diagnosis', color: 'bg-breach-500' },
  { date: 'Jul 2025', label: 'Diagnosis Removed', color: 'bg-vindication-500' }
];
---

<BaseLayout title="Timeline" description="8-phase forensic chronology of the Thomson clinical negligence case">
  <!-- Header -->
  <section class="py-16 bg-navy-900/30">
    <div class="container-wide">
      <div class="max-w-3xl">
        <h1 class="text-4xl font-serif font-bold text-white mb-4">Case Timeline</h1>
        <p class="text-lg text-navy-300">
          Forensic chronology organised into 8 phases, from pre-existing conditions through vindication.
          Events colour-coded by verification status.
        </p>
      </div>
    </div>
  </section>

  <!-- Key Dates Mini-Timeline -->
  <section class="border-y border-navy-800/50 bg-navy-950 overflow-x-auto">
    <div class="container-wide py-6">
      <div class="flex items-center gap-4 min-w-max">
        {keyDates.map((item, index) => (
          <>
            <div class="flex items-center gap-2">
              <div class:list={['w-3 h-3 rounded-full', item.color]}></div>
              <div>
                <p class="text-sm font-semibold text-white">{item.date}</p>
                <p class="text-xs text-navy-400">{item.label}</p>
              </div>
            </div>
            {index < keyDates.length - 1 && (
              <div class="w-12 h-0.5 bg-gradient-to-r from-navy-600 to-navy-800"></div>
            )}
          </>
        ))}
      </div>
    </div>
  </section>

  <!-- Legend -->
  <section class="border-b border-navy-800/50">
    <div class="container-wide py-4">
      <div class="flex flex-wrap items-center gap-4 text-sm">
        <span class="text-navy-500">Status:</span>
        <div class="flex items-center gap-2">
          <div class="w-2 h-2 rounded-full bg-vindication-500"></div>
          <span class="text-navy-300">Verified</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-2 h-2 rounded-full bg-breach-500"></div>
          <span class="text-navy-300">Contradicted</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-2 h-2 rounded-full bg-discrepancy-500"></div>
          <span class="text-navy-300">Unverified</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-2 h-2 rounded-full bg-gold-500"></div>
          <span class="text-navy-300">Key Event</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Timeline -->
  <section class="py-12">
    <div class="container-wide">
      <div class="max-w-4xl mx-auto">
        {phases.map((phase) => (
          <PhaseCard phase={phase} />
        ))}
      </div>
    </div>
  </section>

  <!-- Summary Stats -->
  <section class="py-12 border-t border-navy-800/50 bg-navy-900/30">
    <div class="container-wide">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <div class="text-center">
          <p class="text-3xl font-bold font-serif text-gold-400">8</p>
          <p class="text-sm text-navy-400">Timeline Phases</p>
        </div>
        <div class="text-center">
          <p class="text-3xl font-bold font-serif text-white">{phases.reduce((acc, p) => acc + p.events.length, 0)}+</p>
          <p class="text-sm text-navy-400">Key Events</p>
        </div>
        <div class="text-center">
          <p class="text-3xl font-bold font-serif text-breach-400">11</p>
          <p class="text-sm text-navy-400">Months Delay</p>
        </div>
        <div class="text-center">
          <p class="text-3xl font-bold font-serif text-vindication-400">6+</p>
          <p class="text-sm text-navy-400">Years of Evidence</p>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  // Toggle phase expansion
  document.querySelectorAll('[data-toggle-phase]').forEach(button => {
    button.addEventListener('click', () => {
      const phaseNum = button.getAttribute('data-toggle-phase');
      const events = document.querySelector(`[data-events-phase="${phaseNum}"]`);
      const chevron = button.querySelector('.phase-chevron');

      if (events) {
        events.classList.toggle('hidden');
        chevron?.classList.toggle('rotate-180');
      }
    });
  });

  // Expand first phase by default
  const firstEvents = document.querySelector('[data-events-phase="1"]');
  const firstChevron = document.querySelector('[data-toggle-phase="1"] .phase-chevron');
  firstEvents?.classList.remove('hidden');
  firstChevron?.classList.add('rotate-180');
</script>
