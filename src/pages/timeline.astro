---
/**
 * Timeline Page - V2 Scrollytelling Design
 *
 * Features:
 * - Vertical spine with anchor points
 * - Scroll-triggered event cards sliding in
 * - Floating date ticker
 * - Phase progress indicator
 * - Glassmorphism design
 */

import BaseLayout from '@layouts/BaseLayout.astro';
import GlassCard from '@components/ui/GlassCard.astro';
import TimelineSpine from '@components/timeline/TimelineSpine.astro';
import TimelineEventCard from '@components/timeline/TimelineEventCard.astro';
import ScrollObserver from '@components/timeline/ScrollObserver';
import TheVoid from '@components/timeline/TheVoid.astro';
import Badge from '@components/common/Badge.astro';

// Import timeline data from JSON
import timelineData from '../data/timeline.json';

const base = import.meta.env.BASE_URL;
const getHref = (path: string) => path === '/' ? (base || '/') : `${base}${path}`;

// Get data
const phases = timelineData.phases;
const metadata = timelineData.metadata;
const causationChain = timelineData.causationChain;
const breachRegister = timelineData.breachRegister;
const limitationAnalysis = timelineData.limitationAnalysis;
const colourCoding = timelineData.colourCoding;

// Key anchor points for the spine
const spineAnchors = [
  { id: 'anchor-tos', date: '2019-06-13', shortDate: 'Jun 2019', label: 'TOS Positive', type: 'vindication' as const, findingRef: 'F032' },
  { id: 'anchor-seizure', date: '2021-12-23', shortDate: 'Dec 2021', label: 'First Seizure', type: 'anchor' as const, findingRef: 'F023' },
  { id: 'anchor-mri', date: '2022-10-16', shortDate: 'Oct 2022', label: 'Fractures Confirmed', type: 'anchor' as const, findingRef: 'F048' },
  { id: 'anchor-covert', date: '2023-01-05', shortDate: 'Jan 2023', label: 'Covert Diagnosis', type: 'breach' as const, findingRef: 'F027' },
  { id: 'anchor-vindication', date: '2025-07-22', shortDate: 'Jul 2025', label: 'Diagnosis Removed', type: 'vindication' as const, findingRef: 'F030' },
];

// Transform all events for scroll observer
const allEvents = phases.flatMap((phase: any) => [
  ...phase.truthSpine.map((e: any, i: number) => ({
    id: `${phase.id}-truth-${i}`,
    date: e.date,
    phase: phase.id,
    isAnchor: spineAnchors.some(a => a.findingRef === e.findingRef)
  })),
  ...(phase.gpEntries || []).map((e: any, i: number) => ({
    id: `${phase.id}-gp-${i}`,
    date: e.date,
    phase: phase.id,
    isAnchor: false
  }))
]);

// Count stats
const totalEvents = allEvents.length;
const truthSpineCount = phases.reduce((acc: number, p: any) => acc + p.truthSpine.length, 0);
const gpEntryCount = phases.reduce((acc: number, p: any) => acc + (p.gpEntries?.length || 0), 0);
---

<BaseLayout title="Timeline" description="8-phase forensic chronology with scrollytelling - Thomson clinical negligence case">
  <!-- Scroll Observer (React component for intersection observer) -->
  <ScrollObserver client:load events={allEvents} />

  <!-- Timeline Spine (fixed left sidebar) -->
  <TimelineSpine anchors={spineAnchors} />

  <!-- Hero Header -->
  <section class="relative py-16 lg:py-20 overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-b from-navy-800/30 to-transparent"></div>

    <div class="container-wide relative">
      <div class="max-w-3xl lg:ml-24">
        <Badge variant="default" class="mb-4">Forensic Chronology</Badge>
        <h1 class="text-4xl lg:text-5xl font-display font-bold text-white mb-6">
          Case Timeline
        </h1>
        <p class="text-lg text-navy-300 leading-relaxed mb-6">
          <strong class="text-gold-400">{metadata.totalPhases} phases</strong> spanning from pre-2020 to {metadata.vindicationDate}.
          Scroll to witness the <strong class="text-white">{metadata.diagnosticDelay}</strong> diagnostic delay unfold.
        </p>

        <!-- Quick stats -->
        <div class="flex flex-wrap gap-6 text-sm">
          <div>
            <span class="text-2xl font-display font-bold text-gold-400">{totalEvents}</span>
            <span class="text-navy-400 ml-2">Key Events</span>
          </div>
          <div>
            <span class="text-2xl font-display font-bold text-green-400">{truthSpineCount}</span>
            <span class="text-navy-400 ml-2">Truth Spine</span>
          </div>
          <div>
            <span class="text-2xl font-display font-bold text-navy-300">{gpEntryCount}</span>
            <span class="text-navy-400 ml-2">GP Entries</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Key Moments Mini-Timeline -->
  <section class="border-y border-navy-700/30 bg-navy-900/50 sticky top-16 z-20 backdrop-blur-xl">
    <div class="container-wide py-4">
      <div class="flex items-center gap-2 overflow-x-auto lg:ml-24 scrollbar-hide">
        {spineAnchors.map((anchor, index) => (
          <>
            <a
              href={`#phase-${anchor.date.split('-')[0] === '2019' ? '1' : anchor.date.split('-')[0] === '2020' || anchor.date.split('-')[0] === '2021' && anchor.date.includes('12') ? '3' : '4'}`}
              class:list={[
                'flex-shrink-0 flex items-center gap-2 px-3 py-2 rounded-lg transition-all',
                anchor.type === 'vindication' && 'bg-green-500/10 hover:bg-green-500/20',
                anchor.type === 'breach' && 'bg-red-500/10 hover:bg-red-500/20',
                anchor.type === 'anchor' && 'bg-gold-500/10 hover:bg-gold-500/20',
              ]}
            >
              <div class:list={[
                'w-2.5 h-2.5 rounded-full',
                anchor.type === 'vindication' && 'bg-green-500',
                anchor.type === 'breach' && 'bg-red-500',
                anchor.type === 'anchor' && 'bg-gold-500',
              ]}></div>
              <div>
                <p class:list={[
                  'text-sm font-semibold',
                  anchor.type === 'vindication' && 'text-green-400',
                  anchor.type === 'breach' && 'text-red-400',
                  anchor.type === 'anchor' && 'text-gold-400',
                ]}>{anchor.shortDate}</p>
                <p class="text-xs text-navy-500">{anchor.label}</p>
              </div>
            </a>
            {index < spineAnchors.length - 1 && (
              <div class="w-8 h-px bg-gradient-to-r from-navy-600 to-transparent flex-shrink-0"></div>
            )}
          </>
        ))}
      </div>
    </div>
  </section>

  <!-- Legend -->
  <section class="border-b border-navy-700/30 bg-navy-900/30">
    <div class="container-wide py-4">
      <div class="flex flex-wrap items-center gap-6 text-sm lg:ml-24">
        <span class="text-navy-500 font-medium">Evidence Track:</span>
        <div class="flex items-center gap-2">
          <div class="w-3 h-3 rounded-full bg-green-500"></div>
          <span class="text-green-400">Truth Spine</span>
          <span class="text-navy-600">|</span>
          <span class="text-navy-500 text-xs">High reliability</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-3 h-3 rounded-full bg-navy-500"></div>
          <span class="text-navy-300">GP Record</span>
          <span class="text-navy-600">|</span>
          <span class="text-navy-500 text-xs">Subject to verification</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Scrollytelling Timeline -->
  <section id="scrollytelling-timeline" class="py-12 lg:py-20">
    <div class="container-wide">
      <div class="lg:ml-24 max-w-3xl">
        {phases.map((phase: any) => (
          <>
            {/* THE VOID - Insert between Phase 4 and Phase 5 */}
            {phase.id === 5 && (
              <TheVoid
                startDate="16 Oct 2022"
                endDate="05 Jan 2023"
                delayDays={82}
                delayMonths="~3 months"
                message="MRI confirmed T5-T8 vertebral fractures. Patient was never informed of the results."
              />
            )}
            
            <div id={`phase-${phase.id}`} class="mb-20 last:mb-0">
            <!-- Phase Header -->
            <div class="sticky top-32 z-10 mb-8">
              <GlassCard variant="elevated" padding="md">
                <div class="flex items-start justify-between gap-4">
                  <div>
                    <div class="flex items-center gap-3 mb-2">
                      <span class="text-3xl font-display font-bold text-gold-400">
                        {phase.id.toString().padStart(2, '0')}
                      </span>
                      <div class="h-px flex-1 bg-gradient-to-r from-gold-500/50 to-transparent"></div>
                    </div>
                    <h2 class="text-xl lg:text-2xl font-display font-bold text-white mb-2">
                      {phase.title}
                    </h2>
                    <p class="text-sm text-navy-400">{phase.period}</p>
                  </div>
                </div>
                {phase.keyMessage && (
                  <p class="mt-4 pt-4 border-t border-navy-700/30 text-sm text-navy-300 leading-relaxed">
                    <strong class="text-gold-400">Key:</strong> {phase.keyMessage}
                  </p>
                )}
              </GlassCard>
            </div>

            <!-- Phase Events -->
            <div class="space-y-4 pl-4 border-l-2 border-navy-700/30">
              {/* Truth Spine Events */}
              {phase.truthSpine.map((event: any, i: number) => (
                <TimelineEventCard
                  id={`${phase.id}-truth-${i}`}
                  date={event.date}
                  phase={phase.id}
                  title={event.event}
                  description={event.finding}
                  status="verified"
                  findingRef={event.findingRef}
                  source={event.source}
                  tier={event.tier}
                  isTruthSpine={true}
                  isAnchor={spineAnchors.some(a => a.findingRef === event.findingRef)}
                />
              ))}

              {/* GP Entries (if any) */}
              {(phase.gpEntries || []).map((entry: any, i: number) => (
                <TimelineEventCard
                  id={`${phase.id}-gp-${i}`}
                  date={entry.date}
                  phase={phase.id}
                  title={`GP Entry: ${entry.clinician || 'Unknown'}`}
                  description={entry.content}
                  status={entry.status?.toLowerCase() || 'unverified'}
                  findingRef={entry.findingRef}
                  isGpEntry={true}
                  critical={entry.critical}
                />
              ))}

              {/* Breaches for this phase */}
              {phase.breaches && phase.breaches.length > 0 && (
                <div class="mt-6 p-4 rounded-xl bg-red-500/10 border border-red-500/20">
                  <h4 class="text-sm font-semibold text-red-400 mb-3 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    Breaches Identified
                  </h4>
                  <ul class="space-y-2">
                    {phase.breaches.map((breach: string) => (
                      <li class="text-sm text-red-300 flex items-start gap-2">
                        <span class="text-red-500 mt-1">â€¢</span>
                        {breach}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          </div>
          </>
        ))}
      </div>
    </div>
  </section>

  <!-- Causation Chain -->
  <section class="py-16 border-t border-navy-700/30 bg-navy-900/30">
    <div class="container-wide">
      <div class="lg:ml-24 max-w-3xl">
        <div class="flex items-center gap-3 mb-8">
          <div class="w-4 h-4 rounded-full bg-blue-500"></div>
          <h2 class="text-2xl font-display font-bold text-white">
            Causation Chain
          </h2>
          <Badge variant="causation">{causationChain.findingRef}</Badge>
        </div>

        <p class="text-navy-400 mb-8">{causationChain.title}</p>

        <div class="relative pl-8 border-l-2 border-blue-500/30 space-y-4">
          {causationChain.steps.map((step: any) => (
            <div class="relative">
              <div class:list={[
                'absolute -left-[25px] w-4 h-4 rounded-full border-2 border-navy-900',
                step.critical ? 'bg-red-500' :
                step.breach ? 'bg-amber-500' :
                step.vindication ? 'bg-green-500' : 'bg-blue-500'
              ]}></div>
              <GlassCard
                variant={step.critical ? 'breach' : step.vindication ? 'vindication' : 'default'}
                padding="sm"
              >
                <p class="text-xs text-navy-500 mb-1">{step.date}</p>
                <p class:list={[
                  'text-sm',
                  step.critical ? 'text-red-400 font-semibold' :
                  step.vindication ? 'text-green-400' : 'text-navy-300'
                ]}>{step.event}</p>
              </GlassCard>
            </div>
          ))}
        </div>

        <GlassCard variant="highlight" padding="md" class="mt-8">
          <h4 class="text-sm font-semibold text-gold-400 mb-2">But-For Test</h4>
          <p class="text-sm text-navy-300">{causationChain.butForTest}</p>
        </GlassCard>
      </div>
    </div>
  </section>

  <!-- Breach Register -->
  <section class="py-16 border-t border-navy-700/30">
    <div class="container-wide">
      <div class="lg:ml-24">
        <h2 class="text-2xl font-display font-bold text-white mb-8">Breach Register</h2>

        <div class="overflow-x-auto rounded-xl border border-navy-700/30">
          <table class="w-full text-sm">
            <thead class="bg-navy-800/50">
              <tr>
                <th class="text-left py-3 px-4 text-navy-500 font-medium">ID</th>
                <th class="text-left py-3 px-4 text-navy-500 font-medium">Date</th>
                <th class="text-left py-3 px-4 text-navy-500 font-medium">Clinician</th>
                <th class="text-left py-3 px-4 text-navy-500 font-medium">Nature</th>
                <th class="text-left py-3 px-4 text-navy-500 font-medium">Status</th>
              </tr>
            </thead>
            <tbody>
              {breachRegister.map((breach: any) => (
                <tr class="border-t border-navy-700/30 hover:bg-navy-800/30 transition-colors">
                  <td class="py-3 px-4 font-mono text-gold-400">{breach.id}</td>
                  <td class="py-3 px-4 text-navy-400">{breach.date}</td>
                  <td class="py-3 px-4 text-white">{breach.clinician}</td>
                  <td class="py-3 px-4 text-navy-300">{breach.nature}</td>
                  <td class="py-3 px-4">
                    <Badge variant="vindication">{breach.status}</Badge>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- Limitation Analysis -->
  <section class="py-16 border-t border-navy-700/30 bg-navy-900/30">
    <div class="container-wide">
      <div class="lg:ml-24 max-w-2xl">
        <div class="flex items-center gap-3 mb-8">
          <div class="w-4 h-4 rounded-full bg-gold-500"></div>
          <h2 class="text-2xl font-display font-bold text-white">Limitation Analysis</h2>
          <Badge variant="default">{limitationAnalysis.findingRef}</Badge>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <GlassCard padding="md">
            <p class="text-xs text-navy-500 mb-1">Index Injury</p>
            <p class="text-lg font-semibold text-white">{limitationAnalysis.indexInjury}</p>
          </GlassCard>
          <GlassCard padding="md">
            <p class="text-xs text-navy-500 mb-1">Date of Knowledge</p>
            <p class="text-lg font-semibold text-gold-400">{limitationAnalysis.dateOfKnowledge}</p>
          </GlassCard>
          <GlassCard padding="md">
            <p class="text-xs text-navy-500 mb-1">Limitation Expires</p>
            <p class="text-lg font-semibold text-red-400">{limitationAnalysis.limitationExpires}</p>
          </GlassCard>
          <GlassCard variant="vindication" padding="md">
            <p class="text-xs text-navy-500 mb-1">Time Remaining</p>
            <p class="text-lg font-semibold text-green-400">{limitationAnalysis.timeRemaining}</p>
          </GlassCard>
        </div>

        <p class="text-sm text-navy-400 mt-6">
          <strong class="text-gold-400">s.32(1)(b):</strong> {limitationAnalysis.section32}
        </p>
      </div>
    </div>
  </section>

  <!-- Summary Stats -->
  <section class="py-16 border-t border-navy-700/30">
    <div class="container-wide">
      <div class="lg:ml-24 grid grid-cols-2 md:grid-cols-4 gap-6">
        <div class="text-center">
          <p class="text-4xl font-display font-bold text-gold-400">{metadata.totalPhases}</p>
          <p class="text-sm text-navy-400 mt-1">Timeline Phases</p>
        </div>
        <div class="text-center">
          <p class="text-4xl font-display font-bold text-white">{totalEvents}+</p>
          <p class="text-sm text-navy-400 mt-1">Key Events</p>
        </div>
        <div class="text-center">
          <p class="text-4xl font-display font-bold text-red-400">{metadata.diagnosticDelay}</p>
          <p class="text-sm text-navy-400 mt-1">Diagnostic Delay</p>
        </div>
        <div class="text-center">
          <p class="text-4xl font-display font-bold text-green-400">6+</p>
          <p class="text-sm text-navy-400 mt-1">Years of Evidence</p>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  /* Hide scrollbar for mini-timeline */
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
</style>
