---
import BaseLayout from '@layouts/BaseLayout.astro';
import PhaseCard from '@components/timeline/PhaseCard.astro';
import Badge from '@components/common/Badge.astro';

// Import timeline data from JSON
import timelineData from '../data/timeline.json';

// Get phases and metadata
const phases = timelineData.phases;
const metadata = timelineData.metadata;
const causationChain = timelineData.causationChain;
const breachRegister = timelineData.breachRegister;
const limitationAnalysis = timelineData.limitationAnalysis;
const colourCoding = timelineData.colourCoding;

// Transform phases for PhaseCard component
const transformedPhases = phases.map((phase) => ({
  number: phase.id,
  title: phase.title,
  dateRange: phase.period,
  description: phase.description,
  keyMessage: phase.keyMessage,
  events: [
    // Truth Spine events (high tier)
    ...phase.truthSpine.map((e: any) => ({
      date: e.date,
      title: e.event,
      description: e.finding,
      status: 'verified',
      findingRef: e.findingRef,
      source: e.source,
      tier: e.tier,
      isTruthSpine: true
    })),
    // GP Record entries (lower tier, may be contradicted)
    ...(phase.gpEntries || []).map((e: any) => ({
      date: e.date,
      title: `GP: ${e.clinician || 'Unknown'}`,
      description: e.content,
      status: e.status?.toLowerCase() || 'unverified',
      findingRef: e.findingRef,
      isGpEntry: true,
      critical: e.critical
    }))
  ],
  criticalFindings: phase.criticalFindings,
  breaches: phase.breaches
}));

const keyDates = [
  { date: 'Jun 2019', label: 'TOS Positive', color: 'bg-vindication-500' },
  { date: 'Dec 2021', label: 'First Seizure', color: 'bg-breach-500' },
  { date: 'Oct 2022', label: 'Fractures Found', color: 'bg-gold-500' },
  { date: 'Jan 2023', label: 'Covert Diagnosis', color: 'bg-breach-500' },
  { date: 'Sep 2025', label: 'Diagnosis Removed', color: 'bg-vindication-500' }
];

// Count total events
const totalEvents = transformedPhases.reduce((acc, p) => acc + p.events.length, 0);
---

<BaseLayout title="Timeline" description="8-phase forensic chronology of the Thomson clinical negligence case">
  <!-- Header -->
  <section class="py-16 bg-navy-900/30">
    <div class="container-wide">
      <div class="max-w-3xl">
        <h1 class="text-4xl font-serif font-bold text-white mb-4">Case Timeline</h1>
        <p class="text-lg text-navy-300">
          Forensic chronology organised into {metadata.totalPhases} phases, using a dual-track system:
          <strong class="text-vindication-400">Truth Spine</strong> (independent evidence) vs
          <strong class="text-navy-200">GP Records</strong> (subject to verification).
          Last updated: {metadata.lastUpdated}.
        </p>
      </div>
    </div>
  </section>

  <!-- Key Dates Mini-Timeline -->
  <section class="border-y border-navy-800/50 bg-navy-950 overflow-x-auto">
    <div class="container-wide py-6">
      <div class="flex items-center gap-4 min-w-max">
        {keyDates.map((item, index) => (
          <>
            <div class="flex items-center gap-2">
              <div class:list={['w-3 h-3 rounded-full', item.color]}></div>
              <div>
                <p class="text-sm font-semibold text-white">{item.date}</p>
                <p class="text-xs text-navy-400">{item.label}</p>
              </div>
            </div>
            {index < keyDates.length - 1 && (
              <div class="w-12 h-0.5 bg-gradient-to-r from-navy-600 to-navy-800"></div>
            )}
          </>
        ))}
      </div>
    </div>
  </section>

  <!-- Legend -->
  <section class="border-b border-navy-800/50">
    <div class="container-wide py-4">
      <div class="flex flex-wrap items-center gap-6 text-sm">
        <div class="flex items-center gap-4">
          <span class="text-navy-500">Evidence Status:</span>
          <div class="flex items-center gap-2">
            <div class="w-2.5 h-2.5 rounded-full bg-vindication-500"></div>
            <span class="text-navy-300">{colourCoding.VERIFIED.emoji} Verified</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-2.5 h-2.5 rounded-full bg-discrepancy-500"></div>
            <span class="text-navy-300">{colourCoding.UNVERIFIED.emoji} Unverified</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-2.5 h-2.5 rounded-full bg-breach-500"></div>
            <span class="text-navy-300">{colourCoding.CONTRADICTED.emoji} Contradicted</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-2.5 h-2.5 rounded-full bg-navy-800 border border-navy-600"></div>
            <span class="text-navy-300">{colourCoding.FABRICATED.emoji} Fabricated</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Dual-Track Explanation -->
  <section class="py-6 border-b border-navy-800/50 bg-navy-900/30">
    <div class="container-wide">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="flex items-start gap-3 p-4 rounded-lg bg-vindication-500/10 border border-vindication-500/20">
          <div class="w-8 h-8 rounded-full bg-vindication-500/20 flex items-center justify-center shrink-0">
            <svg class="w-4 h-4 text-vindication-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div>
            <h3 class="font-semibold text-vindication-400 text-sm">Truth Spine (High Reliability)</h3>
            <p class="text-xs text-navy-400 mt-1">Imaging, Ambulance, Hospital, Specialist Letters - establishes objective facts</p>
          </div>
        </div>
        <div class="flex items-start gap-3 p-4 rounded-lg bg-navy-800/50 border border-navy-700">
          <div class="w-8 h-8 rounded-full bg-navy-700 flex items-center justify-center shrink-0">
            <svg class="w-4 h-4 text-navy-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </div>
          <div>
            <h3 class="font-semibold text-navy-300 text-sm">GP Record (Subject to Verification)</h3>
            <p class="text-xs text-navy-400 mt-1">Consultation entries verified against independent evidence - lowest reliability tier</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Timeline -->
  <section class="py-12">
    <div class="container-wide">
      <div class="max-w-4xl mx-auto">
        {transformedPhases.map((phase) => (
          <PhaseCard phase={phase} />
        ))}
      </div>
    </div>
  </section>

  <!-- Causation Chain -->
  <section class="py-12 border-t border-navy-800/50 bg-navy-900/30">
    <div class="container-wide">
      <div class="max-w-4xl mx-auto">
        <h2 class="text-2xl font-serif font-bold text-white mb-6 flex items-center gap-3">
          <span class="w-3 h-3 rounded-full bg-causation-500"></span>
          Causation Chain ({causationChain.findingRef})
        </h2>
        <p class="text-sm text-navy-400 mb-6">{causationChain.title}</p>

        <div class="relative pl-8 border-l-2 border-causation-500/30 space-y-4">
          {causationChain.steps.map((step: any, index: number) => (
            <div class="relative">
              <div class:list={[
                'absolute -left-[25px] w-4 h-4 rounded-full border-2 border-navy-950',
                step.critical ? 'bg-breach-500' :
                step.breach ? 'bg-discrepancy-500' :
                step.vindication ? 'bg-vindication-500' : 'bg-causation-500'
              ]}></div>
              <div class:list={[
                'p-3 rounded-lg',
                step.critical ? 'bg-breach-500/10 border border-breach-500/20' :
                step.breach ? 'bg-discrepancy-500/10 border border-discrepancy-500/20' :
                step.vindication ? 'bg-vindication-500/10 border border-vindication-500/20' :
                'bg-navy-800/50 border border-navy-700'
              ]}>
                <p class="text-xs text-navy-500">{step.date}</p>
                <p class:list={[
                  'text-sm',
                  step.critical ? 'text-breach-400 font-semibold' :
                  step.breach ? 'text-discrepancy-400' :
                  step.vindication ? 'text-vindication-400' : 'text-navy-300'
                ]}>{step.event}</p>
              </div>
            </div>
          ))}
        </div>

        <div class="mt-8 p-4 rounded-lg bg-gold-500/10 border border-gold-500/20">
          <h4 class="text-sm font-semibold text-gold-400 mb-2">But-For Test</h4>
          <p class="text-sm text-navy-300">{causationChain.butForTest}</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Breach Register -->
  <section class="py-12 border-t border-navy-800/50">
    <div class="container-wide">
      <h2 class="text-2xl font-serif font-bold text-white mb-6">Breach Register Summary</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-navy-800">
              <th class="text-left py-3 px-4 text-navy-500 font-medium">ID</th>
              <th class="text-left py-3 px-4 text-navy-500 font-medium">Date</th>
              <th class="text-left py-3 px-4 text-navy-500 font-medium">Clinician/Entity</th>
              <th class="text-left py-3 px-4 text-navy-500 font-medium">Nature of Breach</th>
              <th class="text-left py-3 px-4 text-navy-500 font-medium">Status</th>
            </tr>
          </thead>
          <tbody>
            {breachRegister.map((breach: any) => (
              <tr class="border-b border-navy-800/50 hover:bg-navy-800/30">
                <td class="py-3 px-4 font-mono text-gold-500">{breach.id}</td>
                <td class="py-3 px-4 text-navy-400">{breach.date}</td>
                <td class="py-3 px-4 text-white">{breach.clinician}</td>
                <td class="py-3 px-4 text-navy-300">{breach.nature}</td>
                <td class="py-3 px-4">
                  <Badge variant="vindication">{breach.status}</Badge>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Limitation Analysis -->
  <section class="py-12 border-t border-navy-800/50 bg-navy-900/30">
    <div class="container-wide">
      <div class="max-w-2xl">
        <h2 class="text-2xl font-serif font-bold text-white mb-6 flex items-center gap-3">
          <span class="w-3 h-3 rounded-full bg-gold-500"></span>
          Limitation Analysis ({limitationAnalysis.findingRef})
        </h2>
        <div class="grid grid-cols-2 gap-4">
          <div class="p-4 rounded-lg bg-navy-800/50 border border-navy-700">
            <p class="text-xs text-navy-500 mb-1">Index Injury</p>
            <p class="text-lg font-semibold text-white">{limitationAnalysis.indexInjury}</p>
          </div>
          <div class="p-4 rounded-lg bg-navy-800/50 border border-navy-700">
            <p class="text-xs text-navy-500 mb-1">Date of Knowledge</p>
            <p class="text-lg font-semibold text-gold-400">{limitationAnalysis.dateOfKnowledge}</p>
          </div>
          <div class="p-4 rounded-lg bg-navy-800/50 border border-navy-700">
            <p class="text-xs text-navy-500 mb-1">Limitation Expires</p>
            <p class="text-lg font-semibold text-breach-400">{limitationAnalysis.limitationExpires}</p>
          </div>
          <div class="p-4 rounded-lg bg-vindication-500/10 border border-vindication-500/20">
            <p class="text-xs text-navy-500 mb-1">Time Remaining</p>
            <p class="text-lg font-semibold text-vindication-400">{limitationAnalysis.timeRemaining}</p>
          </div>
        </div>
        <p class="text-sm text-navy-400 mt-4">
          <strong class="text-gold-400">s.32(1)(b):</strong> {limitationAnalysis.section32}
        </p>
      </div>
    </div>
  </section>

  <!-- Summary Stats -->
  <section class="py-12 border-t border-navy-800/50">
    <div class="container-wide">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <div class="text-center">
          <p class="text-3xl font-bold font-serif text-gold-400">{metadata.totalPhases}</p>
          <p class="text-sm text-navy-400">Timeline Phases</p>
        </div>
        <div class="text-center">
          <p class="text-3xl font-bold font-serif text-white">{totalEvents}+</p>
          <p class="text-sm text-navy-400">Key Events</p>
        </div>
        <div class="text-center">
          <p class="text-3xl font-bold font-serif text-breach-400">{metadata.diagnosticDelay}</p>
          <p class="text-sm text-navy-400">Diagnostic Delay</p>
        </div>
        <div class="text-center">
          <p class="text-3xl font-bold font-serif text-vindication-400">6+</p>
          <p class="text-sm text-navy-400">Years of Evidence</p>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  // Toggle phase expansion
  document.querySelectorAll('[data-toggle-phase]').forEach(button => {
    button.addEventListener('click', () => {
      const phaseNum = button.getAttribute('data-toggle-phase');
      const events = document.querySelector(`[data-events-phase="${phaseNum}"]`);
      const chevron = button.querySelector('.phase-chevron');

      if (events) {
        events.classList.toggle('hidden');
        chevron?.classList.toggle('rotate-180');
      }
    });
  });

  // Expand first few phases by default
  [1, 2, 3].forEach(num => {
    const events = document.querySelector(`[data-events-phase="${num}"]`);
    const chevron = document.querySelector(`[data-toggle-phase="${num}"] .phase-chevron`);
    events?.classList.remove('hidden');
    chevron?.classList.add('rotate-180');
  });
</script>
