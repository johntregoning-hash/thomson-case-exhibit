---
import BaseLayout from '@layouts/BaseLayout.astro';
import FindingCard from '@components/findings/FindingCard.astro';
import Badge from '@components/common/Badge.astro';

// Import findings data from JSON
import findingsData from '../data/findings.json';

// Get all findings and metadata
const allFindings = findingsData.findings;
const metadata = findingsData.metadata;
const categoryCounts = findingsData.categoryCounts;
const statusCounts = findingsData.statusCounts;
const priorityFindings = findingsData.priorityFindings;

// Create category list for filters
const categories = [
  { name: 'ALL', count: metadata.totalFindings },
  { name: 'VINDICATION', count: categoryCounts.VINDICATION || 0, variant: 'vindication' },
  { name: 'BREACH', count: categoryCounts.BREACH || 0, variant: 'breach' },
  { name: 'WITNESS', count: categoryCounts.WITNESS || 0, variant: 'witness' },
  { name: 'DISCREPANCY', count: categoryCounts.DISCREPANCY || 0, variant: 'discrepancy' },
  { name: 'CAUSATION', count: categoryCounts.CAUSATION || 0, variant: 'causation' },
  { name: 'NEUROLOGICAL', count: categoryCounts.NEUROLOGICAL || 0, variant: 'causation' },
  { name: 'MEDICATION', count: categoryCounts.MEDICATION || 0, variant: 'breach' },
  { name: 'FND/SOMATOFORM', count: categoryCounts['FND/SOMATOFORM'] || 0, variant: 'breach' },
  { name: 'PROCEDURAL', count: categoryCounts.PROCEDURAL || 0, variant: 'procedural' },
  { name: 'STRATEGIC', count: categoryCounts.STRATEGIC || 0, variant: 'strategic' },
  { name: 'QUANTUM', count: categoryCounts.QUANTUM || 0, variant: 'quantum' }
];

// Sort findings - critical/priority ones first, then by ID
const sortedFindings = [...allFindings].sort((a, b) => {
  // Priority findings first
  const aIsPriority = priorityFindings.includes(a.id);
  const bIsPriority = priorityFindings.includes(b.id);
  if (aIsPriority && !bIsPriority) return -1;
  if (!aIsPriority && bIsPriority) return 1;

  // Then critical findings
  if (a.critical && !b.critical) return -1;
  if (!a.critical && b.critical) return 1;

  // Then by ID
  return a.id.localeCompare(b.id);
});
---

<BaseLayout title="Findings" description="Browse 200+ documented findings in the Thomson clinical negligence case">
  <!-- Header -->
  <section class="py-16 bg-navy-900/30">
    <div class="container-wide">
      <div class="max-w-3xl">
        <h1 class="text-4xl font-serif font-bold text-white mb-4">Findings Registry</h1>
        <p class="text-lg text-navy-300">
          Browse {metadata.totalFindings}+ documented findings, each cross-referenced with primary evidence
          and categorised by type. Last updated: {metadata.lastUpdated}.
        </p>
      </div>
    </div>
  </section>

  <!-- Stats Bar -->
  <section class="border-y border-navy-800/50 bg-navy-950">
    <div class="container-wide py-6">
      <div class="flex flex-wrap items-center gap-6">
        <div class="flex items-center gap-2">
          <span class="text-2xl font-bold text-gold-400">{metadata.totalFindings}+</span>
          <span class="text-sm text-navy-400">Total Findings</span>
        </div>
        <div class="w-px h-8 bg-navy-800 hidden sm:block"></div>
        <div class="flex items-center gap-2">
          <span class="text-2xl font-bold text-vindication-400">{statusCounts.VERIFIED}</span>
          <span class="text-sm text-navy-400">Verified</span>
        </div>
        <div class="w-px h-8 bg-navy-800 hidden sm:block"></div>
        <div class="flex items-center gap-2">
          <span class="text-2xl font-bold text-vindication-500">{categoryCounts.VINDICATION}+</span>
          <span class="text-sm text-navy-400">Vindication</span>
        </div>
        <div class="w-px h-8 bg-navy-800 hidden sm:block"></div>
        <div class="flex items-center gap-2">
          <span class="text-2xl font-bold text-breach-400">{categoryCounts.BREACH}+</span>
          <span class="text-sm text-navy-400">Breach</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Priority Findings Alert -->
  {priorityFindings.length > 0 && (
    <section class="bg-gold-500/10 border-b border-gold-500/30">
      <div class="container-wide py-4">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-gold-500/20 flex items-center justify-center">
            <svg class="w-4 h-4 text-gold-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
            </svg>
          </div>
          <div>
            <span class="text-sm font-semibold text-gold-400">Priority Findings:</span>
            <span class="text-sm text-navy-300 ml-2">{priorityFindings.join(', ')}</span>
          </div>
        </div>
      </div>
    </section>
  )}

  <!-- Category Filters -->
  <section class="sticky top-16 z-40 border-b border-navy-800/50 bg-navy-950/95 backdrop-blur-sm">
    <div class="container-wide">
      <div class="flex items-center gap-2 py-4 overflow-x-auto">
        {categories.map((cat) => (
          <button
            class:list={[
              'px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 whitespace-nowrap',
              cat.name === 'ALL'
                ? 'bg-gold-600 text-navy-950'
                : 'bg-navy-800/50 text-navy-300 hover:bg-navy-800 hover:text-white'
            ]}
            data-category={cat.name}
          >
            {cat.name}
            <span class="ml-2 text-xs opacity-70">{cat.count}</span>
          </button>
        ))}
      </div>
    </div>
  </section>

  <!-- Search -->
  <section class="py-6 border-b border-navy-800/50">
    <div class="container-wide">
      <div class="relative max-w-md">
        <input
          type="text"
          id="finding-search"
          placeholder="Search findings by ID, title, or content..."
          class="w-full px-4 py-3 pl-10 rounded-lg bg-navy-800/50 border border-navy-700 text-white placeholder-navy-500 focus:outline-none focus:border-gold-500 focus:ring-1 focus:ring-gold-500"
        />
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-navy-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>
    </div>
  </section>

  <!-- Findings Grid -->
  <section class="py-12">
    <div class="container-wide">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="findings-grid">
        {sortedFindings.map((finding) => (
          <FindingCard finding={finding} />
        ))}
      </div>

      <!-- Results Count -->
      <div class="mt-8 text-center">
        <p class="text-navy-400" id="results-count">
          Showing <span id="visible-count">{sortedFindings.length}</span> of {metadata.totalFindings}+ findings
        </p>
      </div>
    </div>
  </section>

  <!-- Evidence Status Legend -->
  <section class="py-8 border-t border-navy-800/50 bg-navy-900/30">
    <div class="container-wide">
      <h2 class="text-lg font-serif font-bold text-white mb-4">Evidence Status Key</h2>
      <div class="flex flex-wrap gap-6">
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-vindication-500"></span>
          <span class="text-sm text-navy-300"><strong class="text-vindication-400">VERIFIED</strong> - Confirmed by independent documentary evidence</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-gold-500"></span>
          <span class="text-sm text-navy-300"><strong class="text-gold-400">SUPPORTED</strong> - Consistent with evidence but not definitively proven</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-breach-500"></span>
          <span class="text-sm text-navy-300"><strong class="text-breach-400">CONTRADICTED</strong> - Evidence disproves this claim</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Category Legend -->
  <section class="py-12 border-t border-navy-800/50">
    <div class="container-wide">
      <h2 class="text-xl font-serif font-bold text-white mb-6">Finding Categories</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="card-base p-4">
          <Badge variant="vindication" class="mb-2">VINDICATION</Badge>
          <p class="text-sm text-navy-400">Independent clinicians refuting problematic diagnoses</p>
        </div>
        <div class="card-base p-4">
          <Badge variant="breach" class="mb-2">BREACH</Badge>
          <p class="text-sm text-navy-400">Potential Bolam/Bolitho breach of duty</p>
        </div>
        <div class="card-base p-4">
          <Badge variant="discrepancy" class="mb-2">DISCREPANCY</Badge>
          <p class="text-sm text-navy-400">GP entries contradicting contemporaneous evidence</p>
        </div>
        <div class="card-base p-4">
          <Badge variant="witness" class="mb-2">WITNESS</Badge>
          <p class="text-sm text-navy-400">Third-party corroboration of events</p>
        </div>
        <div class="card-base p-4">
          <Badge variant="causation" class="mb-2">CAUSATION</Badge>
          <p class="text-sm text-navy-400">Evidence linking breach to harm</p>
        </div>
        <div class="card-base p-4">
          <Badge variant="quantum" class="mb-2">QUANTUM</Badge>
          <p class="text-sm text-navy-400">Damages evidence</p>
        </div>
        <div class="card-base p-4">
          <Badge variant="procedural" class="mb-2">PROCEDURAL</Badge>
          <p class="text-sm text-navy-400">Administrative/data protection issues</p>
        </div>
        <div class="card-base p-4">
          <Badge variant="strategic" class="mb-2">STRATEGIC</Badge>
          <p class="text-sm text-navy-400">Case strategy insights</p>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  // Category filtering
  const buttons = document.querySelectorAll('[data-category]') as NodeListOf<HTMLButtonElement>;
  const cards = document.querySelectorAll('[data-finding-id]') as NodeListOf<HTMLElement>;
  const searchInput = document.getElementById('finding-search') as HTMLInputElement;
  const visibleCountEl = document.getElementById('visible-count');

  let activeCategory = 'ALL';
  let searchTerm = '';

  function filterCards() {
    let visibleCount = 0;

    cards.forEach(card => {
      const cardCategory = card.dataset.category || '';
      const cardText = card.textContent?.toLowerCase() || '';
      const cardId = card.dataset.findingId?.toLowerCase() || '';

      const matchesCategory = activeCategory === 'ALL' || cardCategory === activeCategory;
      const matchesSearch = !searchTerm ||
        cardText.includes(searchTerm) ||
        cardId.includes(searchTerm);

      if (matchesCategory && matchesSearch) {
        card.style.display = 'block';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });

    if (visibleCountEl) {
      visibleCountEl.textContent = String(visibleCount);
    }
  }

  buttons.forEach(button => {
    button.addEventListener('click', () => {
      activeCategory = button.dataset.category || 'ALL';

      // Update button styles
      buttons.forEach(btn => {
        btn.classList.remove('bg-gold-600', 'text-navy-950');
        btn.classList.add('bg-navy-800/50', 'text-navy-300');
      });
      button.classList.remove('bg-navy-800/50', 'text-navy-300');
      button.classList.add('bg-gold-600', 'text-navy-950');

      filterCards();
    });
  });

  // Search functionality
  searchInput?.addEventListener('input', (e) => {
    searchTerm = (e.target as HTMLInputElement).value.toLowerCase();
    filterCards();
  });
</script>
