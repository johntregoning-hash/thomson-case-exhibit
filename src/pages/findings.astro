---
import BaseLayout from '@layouts/BaseLayout.astro';
import FindingCard from '@components/findings/FindingCard.astro';
import Badge from '@components/common/Badge.astro';

// Sample findings data - in production, this would come from parseFindings()
const categories = [
  { name: 'ALL', count: 200 },
  { name: 'VINDICATION', count: 22, variant: 'vindication' },
  { name: 'BREACH', count: 24, variant: 'breach' },
  { name: 'WITNESS', count: 10, variant: 'witness' },
  { name: 'DISCREPANCY', count: 4, variant: 'discrepancy' },
  { name: 'CAUSATION', count: 6, variant: 'causation' },
  { name: 'PROCEDURAL', count: 5, variant: 'procedural' },
  { name: 'STRATEGIC', count: 4, variant: 'strategic' }
];

// Sample findings for display
const sampleFindings = [
  {
    id: 'F030',
    title: 'Dr Gorrie Removes Somatoform Diagnosis',
    category: 'VINDICATION',
    summary: 'Dr Alexander Gorrie marked the Somatoform Pain Disorder diagnosis as INACTIVE on 22 July 2025, noting "there were clear causes for his pain."',
    evidenceStatus: 'VERIFIED',
    legalSignificance: 'Subsequent NHS clinician independently determined original psychiatric diagnosis was inappropriate and removed it.'
  },
  {
    id: 'F031',
    title: 'Pain Clinic Refutes Somatoform',
    category: 'VINDICATION',
    summary: 'Pain Clinic explicitly disagreed with somatoform characterisation. GP record states: "GP prev told somatic, pain clinic at C&W; felt not somatic."',
    evidenceStatus: 'VERIFIED',
    legalSignificance: 'Independent specialist refutation of GP diagnosis.'
  },
  {
    id: 'F032',
    title: '2019 Duplex Ultrasound Shows TOS-Positive Result',
    category: 'VINDICATION',
    summary: 'Bilateral upper-limb arterial duplex study recorded complete cessation of flow within the distal subclavian artery during provocative manoeuvres.',
    evidenceStatus: 'VERIFIED',
    legalSignificance: 'High-tier objective evidence that vascular compression existed years before later disputes.'
  },
  {
    id: 'F038',
    title: 'Psychiatric Assessment Clearance',
    category: 'VINDICATION',
    summary: 'Psychiatric assessment by Dr Gupta found NO: PTSD, depression, psychosis, personality disorder, OR somatisation disorder.',
    evidenceStatus: 'VERIFIED',
    legalSignificance: 'Formal psychiatric clearance undermines somatoform labelling.'
  },
  {
    id: 'F040',
    title: 'Covert Somatoform Diagnosis Applied',
    category: 'BREACH',
    summary: 'F45.4 Somatoform Pain Disorder was applied on 05 January 2023 without psychiatric assessment, without patient knowledge, and without clinical justification.',
    evidenceStatus: 'VERIFIED',
    legalSignificance: 'Diagnosis applied without psychiatric assessment. Contaminates medical record and referral pathways.'
  },
  {
    id: 'F042',
    title: 'Pregabalin Reduction Against BNF Guidance',
    category: 'BREACH',
    summary: 'Pregabalin reduced from 600mg to 100mg (83% reduction) without the gradual taper required by BNF guidance.',
    evidenceStatus: 'VERIFIED',
    legalSignificance: 'Breach of prescribing guidelines. Seizure risk factor and causation relevant.'
  },
  {
    id: 'F001',
    title: 'Bulale "Sleeping Pain-Free" Entry',
    category: 'DISCREPANCY',
    summary: 'Dr Bulale Ali recorded patient was "sleeping pain-free" in September 2021, contradicting documented inability to lie flat due to thoracic pain.',
    evidenceStatus: 'CONTRADICTED',
    legalSignificance: 'Demonstrates either failure to accurately document or deliberate falsification.'
  },
  {
    id: 'F002',
    title: '2020 MH1 Referral Contains Somatisation Framing',
    category: 'DISCREPANCY',
    summary: 'GP referral to mental health services includes narrative linking symptoms to brother\'s death and explicitly mentions "somatisation" - predating injury events.',
    evidenceStatus: 'VERIFIED',
    legalSignificance: 'Pre-existing documented "psychological overlay" narrative in GP records BEFORE key injury events.'
  },
  {
    id: 'F020',
    title: 'Dr Karunaratne "Data Manipulation" Statement',
    category: 'WITNESS',
    summary: 'NHS epilepsy specialist Dr Karunaratne verbally used the phrase "data manipulation" when discussing GP care issues, with patient\'s parents present.',
    evidenceStatus: 'VERIFIED',
    legalSignificance: 'Independent NHS specialist raising concerns about data integrity at former practice.'
  },
  {
    id: 'F022',
    title: 'MSK Physio "Attention Seeking" Documentation',
    category: 'WITNESS',
    summary: 'Independent MSK physiotherapist documented: "issues with GP, as they did not believe his pain and accused him for attention seeking" - PREDATES the seizure.',
    evidenceStatus: 'VERIFIED',
    legalSignificance: 'Third-party contemporaneous documentation of GP dismissal pattern BEFORE the major injury event.'
  },
  {
    id: 'F023',
    title: 'Ambulance ePCR Corroborates 23 Dec 2021 Seizure',
    category: 'WITNESS',
    summary: 'London Ambulance Service ePCR documents a witnessed tonic-clonic seizure with 5-minute response time, HR 133 bpm, and Entonox administered for back pain.',
    evidenceStatus: 'VERIFIED',
    legalSignificance: 'Highest-tier contemporaneous evidence with hardcoded timestamps from third-party source.'
  },
  {
    id: 'F050',
    title: 'T5-T8 Fractures Discovered After 11-Month Delay',
    category: 'CAUSATION',
    summary: 'MRI in November 2022 reveals T5-T8 vertebral fractures that explain ongoing thoracic pain - 11 months after the index seizure event.',
    evidenceStatus: 'VERIFIED',
    legalSignificance: 'Documents the 11-month diagnostic delay that is central to the negligence claim.'
  }
];
---

<BaseLayout title="Findings" description="Browse 200+ documented findings in the Thomson clinical negligence case">
  <!-- Header -->
  <section class="py-16 bg-navy-900/30">
    <div class="container-wide">
      <div class="max-w-3xl">
        <h1 class="text-4xl font-serif font-bold text-white mb-4">Findings Registry</h1>
        <p class="text-lg text-navy-300">
          Browse {categories[0].count}+ documented findings, each cross-referenced with primary evidence
          and categorised by type.
        </p>
      </div>
    </div>
  </section>

  <!-- Stats Bar -->
  <section class="border-y border-navy-800/50 bg-navy-950">
    <div class="container-wide py-6">
      <div class="flex flex-wrap items-center gap-6">
        <div class="flex items-center gap-2">
          <span class="text-2xl font-bold text-gold-400">{categories[0].count}+</span>
          <span class="text-sm text-navy-400">Total Findings</span>
        </div>
        <div class="w-px h-8 bg-navy-800 hidden sm:block"></div>
        <div class="flex items-center gap-2">
          <span class="text-2xl font-bold text-vindication-400">{categories[1].count}+</span>
          <span class="text-sm text-navy-400">Vindication</span>
        </div>
        <div class="w-px h-8 bg-navy-800 hidden sm:block"></div>
        <div class="flex items-center gap-2">
          <span class="text-2xl font-bold text-breach-400">{categories[2].count}+</span>
          <span class="text-sm text-navy-400">Breach</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Category Filters -->
  <section class="sticky top-16 z-40 border-b border-navy-800/50 bg-navy-950/95 backdrop-blur-sm">
    <div class="container-wide">
      <div class="flex items-center gap-2 py-4 overflow-x-auto">
        {categories.map((cat) => (
          <button
            class:list={[
              'px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 whitespace-nowrap',
              cat.name === 'ALL'
                ? 'bg-gold-600 text-navy-950'
                : 'bg-navy-800/50 text-navy-300 hover:bg-navy-800 hover:text-white'
            ]}
            data-category={cat.name}
          >
            {cat.name}
            <span class="ml-2 text-xs opacity-70">{cat.count}</span>
          </button>
        ))}
      </div>
    </div>
  </section>

  <!-- Findings Grid -->
  <section class="py-12">
    <div class="container-wide">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="findings-grid">
        {sampleFindings.map((finding) => (
          <FindingCard finding={finding} />
        ))}
      </div>

      <!-- Load More -->
      <div class="mt-12 text-center">
        <p class="text-navy-400 mb-4">Showing 12 of {categories[0].count}+ findings</p>
        <button class="btn-secondary">
          Load More Findings
        </button>
      </div>
    </div>
  </section>

  <!-- Category Legend -->
  <section class="py-12 border-t border-navy-800/50">
    <div class="container-wide">
      <h2 class="text-xl font-serif font-bold text-white mb-6">Finding Categories</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="card-base p-4">
          <Badge variant="vindication" class="mb-2">VINDICATION</Badge>
          <p class="text-sm text-navy-400">Independent clinicians refuting problematic diagnoses</p>
        </div>
        <div class="card-base p-4">
          <Badge variant="breach" class="mb-2">BREACH</Badge>
          <p class="text-sm text-navy-400">Potential Bolam/Bolitho breach of duty</p>
        </div>
        <div class="card-base p-4">
          <Badge variant="discrepancy" class="mb-2">DISCREPANCY</Badge>
          <p class="text-sm text-navy-400">GP entries contradicting contemporaneous evidence</p>
        </div>
        <div class="card-base p-4">
          <Badge variant="witness" class="mb-2">WITNESS</Badge>
          <p class="text-sm text-navy-400">Third-party corroboration of events</p>
        </div>
        <div class="card-base p-4">
          <Badge variant="causation" class="mb-2">CAUSATION</Badge>
          <p class="text-sm text-navy-400">Evidence linking breach to harm</p>
        </div>
        <div class="card-base p-4">
          <Badge variant="quantum" class="mb-2">QUANTUM</Badge>
          <p class="text-sm text-navy-400">Damages evidence</p>
        </div>
        <div class="card-base p-4">
          <Badge variant="procedural" class="mb-2">PROCEDURAL</Badge>
          <p class="text-sm text-navy-400">Administrative/data protection issues</p>
        </div>
        <div class="card-base p-4">
          <Badge variant="strategic" class="mb-2">STRATEGIC</Badge>
          <p class="text-sm text-navy-400">Case strategy insights</p>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  // Simple client-side filtering
  const buttons = document.querySelectorAll('[data-category]') as NodeListOf<HTMLButtonElement>;
  const cards = document.querySelectorAll('[data-finding-id]') as NodeListOf<HTMLElement>;

  buttons.forEach(button => {
    button.addEventListener('click', () => {
      const category = button.dataset.category;

      // Update button styles
      buttons.forEach(btn => {
        btn.classList.remove('bg-gold-600', 'text-navy-950');
        btn.classList.add('bg-navy-800/50', 'text-navy-300');
      });
      button.classList.remove('bg-navy-800/50', 'text-navy-300');
      button.classList.add('bg-gold-600', 'text-navy-950');

      // Filter cards
      cards.forEach(card => {
        if (category === 'ALL' || card.dataset.category === category) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    });
  });
</script>
